<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ewing.query.dao.DictionaryDao">
  <select id="countSame" resultType="java.lang.Long">
    select count(*)
    from dictionary
    where
    <choose>
      <when test="parentId == null">
        parent_id is null
      </when>
      <otherwise>
        parent_id = #{parentId}
      </otherwise>
    </choose>
    and (name = #{name} or value = #{value})
  </select>

  <select id="countDictionary" resultType="java.lang.Long" parameterType="ewing.common.vo.FindDictionaryParam">
    SELECT count(*)
    FROM (
    SELECT DISTINCT
    `dictionary`.`create_time`,
    `dictionary`.`detail`,
    `dictionary`.`dictionary_id`,
    `dictionary`.`name`,
    `dictionary`.`parent_id`,
    `dictionary`.`root_id`,
    `dictionary`.`value`
    FROM
    `dictionary` `dictionary`
    LEFT JOIN `dictionary` `sub` ON `dictionary`.`dictionary_id` = `sub`.`root_id`
    WHERE
    `dictionary`.`root_id` IS NULL
    <if test="name != null and name !=''">
      AND (`dictionary`.`name` LIKE concat('%',#{name},'%')
      OR `sub`.`name` LIKE  concat('%',#{name},'%'))
    </if>
    <if test="value != null and value !=''">
      AND (`dictionary`.`value` LIKE concat('%',#{value},'%')
      OR `sub`.`value` LIKE concat('%',#{value},'%'))
    </if>
    ) internal
  </select>

  <select id="findWithSubDictionary" resultType="ewing.query.entity.Dictionary" parameterType="ewing.common.vo.FindDictionaryParam">
    SELECT DISTINCT
    `sub`.`create_time`,
    `sub`.`detail`,
    `sub`.`dictionary_id`,
    `sub`.`name`,
    `sub`.`parent_id`,
    `sub`.`root_id`,
    `sub`.`value`
    FROM (
    SELECT DISTINCT
    `dictionary`.`create_time`,
    `dictionary`.`detail`,
    `dictionary`.`dictionary_id`,
    `dictionary`.`name`,
    `dictionary`.`parent_id`,
    `dictionary`.`root_id`,
    `dictionary`.`value`
    FROM
    `dictionary` `dictionary`
    LEFT JOIN `dictionary` `sub` ON `dictionary`.`dictionary_id` = `sub`.`root_id`
    WHERE
    `dictionary`.`root_id` IS NULL
    <if test="name != null and name !=''">
      AND (`dictionary`.`name` LIKE concat('%',#{name},'%')
      OR `sub`.`name` LIKE  concat('%',#{name},'%'))
    </if>
    <if test="value != null and value !=''">
      AND (`dictionary`.`value` LIKE concat('%',#{value},'%')
      OR `sub`.`value` LIKE concat('%',#{value},'%'))
    </if>
    LIMIT #{limit} OFFSET #{offset}
    ) AS `dictionary`
    LEFT JOIN `dictionary` `sub`
    ON `dictionary`.`dictionary_id` = `sub`.`dictionary_id`
    OR `dictionary`.`dictionary_id` = `sub`.`root_id`
  </select>
</mapper>